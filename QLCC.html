<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ch·∫•m C√¥ng UTC (V10 Ultimate)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* === 1. DESIGN SYSTEM === */
        :root {
            --primary: #4f46e5;      /* T√≠m xanh hi·ªán ƒë·∫°i */
            --primary-light: #e0e7ff;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        /* DARK MODE */
        [data-theme="dark"] {
            --primary: #6366f1; --primary-light: #312e81; --bg-body: #0f172a; --bg-card: #1e293b;
            --text-main: #f1f5f9; --text-sub: #94a3b8; --shadow: none;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; height: 100vh; display: flex; overflow: hidden; transition: 0.3s; }

        /* === 2. LAYOUT & NAVIGATION === */
        /* PC: Sidebar */
        .sidebar { width: 260px; background: var(--bg-card); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #e2e8f0; z-index: 50; transition: 0.3s; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
        .nav-link { padding: 12px 15px; border-radius: 12px; color: var(--text-sub); font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; transition: 0.2s; }
        .nav-link:hover { background: var(--bg-body); color: var(--primary); }
        .nav-link.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .top-bar { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; background: transparent; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 0 30px 100px 30px; } /* Padding bottom ƒë·ªÉ tr√°nh Bottom Nav che */

        /* MOBILE: Bottom Navigation */
        .bottom-nav { display: none; }
        
        @media (max-width: 768px) {
            .sidebar { display: none; } /* ·∫®n sidebar tr√™n mobile */
            .top-bar { padding: 0 15px; }
            .content-scroll { padding: 15px 15px 90px 15px; }
            
            .bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
                background: var(--bg-card); box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
                justify-content: space-around; align-items: center; z-index: 100;
                border-top-left-radius: 20px; border-top-right-radius: 20px;
            }
            .b-nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 0.75rem; gap: 4px; transition: 0.2s; }
            .b-nav-item i { font-size: 1.2rem; }
            .b-nav-item.active { color: var(--primary); transform: translateY(-5px); }
        }

        /* === 3. UI COMPONENTS === */
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); transition: 0.3s; }
        .card h3 { margin: 0 0 15px 0; font-size: 1.1rem; color: var(--text-main); }
        
        .btn { padding: 10px 18px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-soft { background: var(--primary-light); color: var(--primary); }

        .form-control { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid #e2e8f0; background: var(--bg-body); color: var(--text-main); margin-bottom: 15px; outline: none; font-family: inherit; transition: 0.2s; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        /* TABLES */
        .table-responsive { overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; padding: 15px; background: var(--bg-body); color: var(--text-sub); font-size: 0.8rem; text-transform: uppercase; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; font-size: 0.9rem; }
        
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge-id { background: var(--primary-light); color: var(--primary); }
        .badge-green { background: #d1fae5; color: #047857; }
        .badge-red { background: #fee2e2; color: #b91c1c; }
        .badge-yellow { background: #fef3c7; color: #b45309; }

        /* === 4. POPUPS & OVERLAYS === */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: var(--bg-card); padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* LOGIN PAGE */
        #login-page { position: fixed; inset: 0; z-index: 10000; background: var(--bg-body); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .login-wrapper { background: var(--bg-card); width: 100%; max-width: 400px; padding: 40px; border-radius: 24px; box-shadow: var(--shadow); text-align: center; }
        .role-switch { display: flex; background: var(--bg-body); padding: 5px; border-radius: 12px; margin-bottom: 25px; }
        .role-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; background: transparent; color: var(--text-sub); font-weight: 600; cursor: pointer; transition: 0.2s; }
        .role-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .hidden { display: none !important; }
        .flex-row { display: flex; gap: 10px; }
        .flex-col-1 { flex: 1; }

        @media (max-width: 768px) {
            .flex-row { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>

<div id="new-id-modal" class="overlay">
    <div class="modal-box">
        <div style="font-size: 4rem; color: var(--warning); margin-bottom: 10px;"><i class="fa-solid fa-fingerprint"></i></div>
        <h2 style="margin: 0;">Ph√°t Hi·ªán M·ªõi</h2>
        <h1 id="modal-id" style="font-size: 3rem; color: var(--primary); margin: 5px 0;">--</h1>
        <p style="color: var(--text-sub); margin-bottom: 25px;">ƒê√£ t·ª± ƒë·ªông l∆∞u gi·ªù v√†o h·ªá th·ªëng.<br>Th√™m t√™n nh√¢n vi√™n ngay?</p>
        <div class="flex-row">
            <button class="btn btn-primary" onclick="acceptNewID()">Th√™m Ngay</button>
            <button class="btn btn-soft" onclick="closeNewID()">ƒê·ªÉ Sau</button>
        </div>
    </div>
</div>

<div id="login-page">
    <div class="login-wrapper">
        <h1 style="color: var(--primary); margin-bottom: 10px;"><i class="fa-solid fa-clock"></i> UTC Time</h1>
        <p style="color: var(--text-sub); margin-bottom: 30px;">H·ªá th·ªëng ch·∫•m c√¥ng th√¥ng minh</p>

        <div class="role-switch">
            <button class="role-btn active" onclick="switchRole('emp')">Nh√¢n Vi√™n</button>
            <button class="role-btn" onclick="switchRole('admin')">Qu·∫£n Tr·ªã</button>
        </div>

        <div id="form-emp">
            <select id="login-select" class="form-control"><option>ƒêang t·∫£i d·ªØ li·ªáu...</option></select>
            <button class="btn btn-primary" style="width:100%" onclick="loginEmp()">Xem Ch·∫•m C√¥ng</button>
        </div>

        <div id="form-admin" class="hidden">
            <input type="text" id="user" class="form-control" placeholder="T√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="pass" class="form-control" placeholder="M·∫≠t kh·∫©u">
            <button class="btn btn-primary" style="width:100%" onclick="loginAdmin()">ƒêƒÉng Nh·∫≠p</button>
        </div>
    </div>
</div>

<nav class="sidebar">
    <div class="logo"><i class="fa-solid fa-clock"></i> UTC Time</div>
    <div class="nav-link active" onclick="openTab('dashboard')"><i class="fa-solid fa-chart-pie"></i> T·ªïng Quan</div>
    <div class="nav-link" onclick="openTab('live')"><i class="fa-solid fa-video"></i> Gi√°m S√°t</div>
    <div class="nav-link" onclick="openTab('salary')"><i class="fa-solid fa-money-bill-wave"></i> T√≠nh L∆∞∆°ng</div>
    <div class="nav-link" onclick="openTab('users')"><i class="fa-solid fa-users"></i> Nh√¢n S·ª±</div>
</nav>

<div class="main-content">
    <div class="top-bar">
        <button class="btn btn-soft" style="width: auto;" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div style="text-align: right;">
                <div id="display-name" style="font-weight: 700;">Guest</div>
                <div id="display-role" style="font-size: 0.8rem; color: var(--text-sub);">User</div>
            </div>
            <button class="btn btn-danger" style="width: auto; padding: 10px;" onclick="location.reload()"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </div>

    <div class="content-scroll">
        <div class="container">
            
            <div id="view-emp" class="hidden">
                <div class="card">
                    <h3>üìÖ L·ªãch S·ª≠ C·ªßa B·∫°n</h3>
                    <div class="table-responsive">
                        <table id="emp-table"><thead><tr><th>Th·ªùi Gian</th><th>Tr·∫°ng Th√°i</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>

            <div id="view-admin" class="hidden">
                
                <div id="tab-dashboard" class="tab-content">
                    <div class="flex-row">
                        <div class="card flex-col-1">
                            <h3>T·ª∑ L·ªá H√¥m Nay</h3>
                            <canvas id="chartPie" style="max-height: 200px;"></canvas>
                        </div>
                        <div class="card flex-col-2">
                            <h3>Th·ªëng K√™ 7 Ng√†y</h3>
                            <canvas id="chartBar" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>

                <div id="tab-live" class="tab-content hidden">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                            <h3>üî¥ Gi√°m S√°t Realtime</h3>
                            <input type="time" id="work-time" value="08:00" class="form-control" style="width: auto; margin:0">
                        </div>
                        <div class="table-responsive">
                            <table id="live-table">
                                <thead><tr><th>Th·ªùi Gian</th><th>M√£ NV</th><th>H·ªç T√™n</th><th>Tr·∫°ng Th√°i</th><th>X√≥a</th></tr></thead>
                                <tbody id="live-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-salary" class="tab-content hidden">
                    <div class="card">
                        <div class="flex-row">
                            <input type="month" id="month-filter" class="form-control">
                            <input type="number" id="salary-val" class="form-control" value="500000">
                        </div>
                        <div class="flex-row" style="margin-top:10px">
                            <button class="btn btn-primary flex-col-1" onclick="calcSalary()">T√≠nh L∆∞∆°ng</button>
                            <button class="btn btn-soft flex-col-1" onclick="exportExcel()">Excel</button>
                            <button class="btn btn-danger flex-col-1" onclick="deleteMonth()">X√≥a Data</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>K·∫øt Qu·∫£: <span id="total-money" style="color:var(--success)">0 ƒë</span></h3>
                        <div class="table-responsive">
                            <table id="salary-table"><thead><tr><th>M√£ NV</th><th>T√™n</th><th>C√¥ng</th><th>Ti·ªÅn</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="tab-users" class="tab-content hidden">
                    <div class="flex-row">
                        <div class="card flex-col-1">
                            <h3>Th√™m / S·ª≠a</h3>
                            <input type="number" id="inp-id" class="form-control" placeholder="ID V√¢n Tay (VD: 1)">
                            <input type="text" id="inp-code" class="form-control" placeholder="M√£ NV (VD: NV01)">
                            <input type="text" id="inp-name" class="form-control" placeholder="H·ªç v√† T√™n">
                            <div class="flex-row">
                                <button class="btn btn-primary" onclick="saveUser()">L∆∞u</button>
                                <button class="btn btn-danger hidden" id="btn-del-user" onclick="delUser()">X√≥a</button>
                            </div>
                            <button class="btn btn-soft" style="width:100%; margin-top:10px" onclick="resetForm()">L√†m m·ªõi</button>
                        </div>
                        <div class="card flex-col-2">
                            <h3>Danh S√°ch</h3>
                            <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                                <table id="users-list"><thead><tr><th>ID</th><th>M√£</th><th>T√™n</th></tr></thead><tbody></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="bottom-nav" id="mobile-nav">
    <div class="b-nav-item active" onclick="openTab('dashboard', this)"><i class="fa-solid fa-chart-pie"></i><span>T·ªïng Quan</span></div>
    <div class="b-nav-item" onclick="openTab('live', this)"><i class="fa-solid fa-video"></i><span>Gi√°m S√°t</span></div>
    <div class="b-nav-item" onclick="openTab('salary', this)"><i class="fa-solid fa-money-bill-wave"></i><span>L∆∞∆°ng</span></div>
    <div class="b-nav-item" onclick="openTab('users', this)"><i class="fa-solid fa-users"></i><span>Nh√¢n S·ª±</span></div>
</div>

<script>
    // 1. CONFIGURATION
    const firebaseConfig = {
        apiKey: "HAY_DIEN_API_KEY_CUA_BAN_VAO_DAY", 
        authDomain: "quanlychamcong-9dacd.firebaseapp.com",
        databaseURL: "https://quanlychamcong-9dacd-default-rtdb.firebaseio.com",
        projectId: "quanlychamcong-9dacd",
        storageBucket: "quanlychamcong-9dacd.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // GLOBAL VARIABLES
    let usersCache = {};
    let newID = null;
    let processedNewIDs = new Set();
    let currentRole = 'Guest';
    let chartPie = null, chartBar = null;

    // --- UTILITIES ---
    function getCurrentDateTime() {
        const now = new Date();
        const d = String(now.getDate()).padStart(2,'0');
        const m = String(now.getMonth()+1).padStart(2,'0');
        const y = now.getFullYear();
        const h = String(now.getHours()).padStart(2,'0');
        const min = String(now.getMinutes()).padStart(2,'0');
        const s = String(now.getSeconds()).padStart(2,'0');
        return `${d}/${m}/${y} ${h}:${min}:${s}`;
    }

    function getUserInfo(id) {
        const u = usersCache[id];
        if (!u) return { name: null, code: "---" };
        if (typeof u === 'string') return { name: u, code: "---" };
        return { name: u.name, code: u.code || "---" };
    }

    function toggleTheme() {
        const body = document.body;
        if(body.getAttribute('data-theme') === 'dark') body.removeAttribute('data-theme');
        else body.setAttribute('data-theme', 'dark');
    }

    // --- CORE LOGIC: NEW ENROLL & ANTI-DUPLICATE ---
    db.ref('new_enroll').on('value', async (snap) => {
        const val = snap.val();
        
        if (val) {
            newID = val;
            
            // LOGIC CH·ªêNG TR√ôNG L·∫∂P (ANTI-DUPLICATE)
            // Ki·ªÉm tra xem ID n√†y ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong phi√™n n√†y ch∆∞a
            if (!processedNewIDs.has(val)) {
                
                // Ki·ªÉm tra k·ªπ h∆°n: L·∫•y log cu·ªëi c√πng c·ªßa ID n√†y trong DB
                // N·∫øu log cu·ªëi c√πng c√°ch ƒë√¢y < 60 gi√¢y -> B·ªè qua (Coi nh∆∞ tr√πng)
                const lastLogSnap = await db.ref('attendance').orderByChild('id').equalTo(String(val)).limitToLast(1).once('value');
                const lastLogData = lastLogSnap.val();
                
                let isDuplicate = false;
                if(lastLogData) {
                    const logKey = Object.keys(lastLogData)[0];
                    const logTimeStr = lastLogData[logKey].timestamp; // DD/MM/YYYY HH:mm:ss
                    
                    // Convert logTimeStr to Date Object for comparison
                    const [d, t] = logTimeStr.split(' ');
                    const [day, month, year] = d.split('/');
                    const logDate = new Date(`${year}-${month}-${day}T${t}`);
                    const now = new Date();
                    
                    // N·∫øu th·ªùi gian ch√™nh l·ªách < 60000ms (1 ph√∫t) -> Tr√πng
                    if ((now - logDate) < 60000) {
                        isDuplicate = true;
                        console.log("Duplicate detected. Skipping auto-log.");
                    }
                }

                if (!isDuplicate) {
                    // N·∫øu kh√¥ng tr√πng -> Ghi log m·ªõi
                    db.ref('attendance').push({
                        id: val,
                        timestamp: getCurrentDateTime(),
                        auto_generated: true
                    });
                    processedNewIDs.add(val);
                }
            }

            // CH·ªà HI·ªÜN POPUP N·∫æU L√Ä ADMIN
            if (currentRole === 'Admin') {
                document.getElementById('modal-id').innerText = newID;
                document.getElementById('new-id-modal').style.display = 'flex';
            }
        } else {
            document.getElementById('new-id-modal').style.display = 'none';
        }
    });

    function acceptNewID() {
        closeNewID();
        openTab('users');
        document.getElementById('inp-id').value = newID;
        document.getElementById('inp-code').focus();
        db.ref('new_enroll').remove();
    }
    
    function closeNewID() {
        document.getElementById('new-id-modal').style.display = 'none';
        // ƒê·ª£i 1 ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o admin ƒë√£ nh√¨n th·∫•y r·ªìi m·ªõi x√≥a c·ªù, ho·∫∑c x√≥a lu√¥n t√πy logic
        db.ref('new_enroll').remove();
    }

    // --- DATA LISTENER ---
    db.ref('users').on('value', snap => {
        usersCache = snap.val() || {};
        renderLoginDropdown();
        if (currentRole === 'Admin') {
            renderUserList();
            loadMonitor();
        }
    });

    // --- AUTHENTICATION ---
    function switchRole(role) {
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('form-emp').classList.add('hidden');
        document.getElementById('form-admin').classList.add('hidden');
        document.getElementById('form-' + role).classList.remove('hidden');
    }

    function renderLoginDropdown() {
        const sel = document.getElementById('login-select');
        sel.innerHTML = '<option value="">-- Ch·ªçn t√™n --</option>';
        Object.keys(usersCache).forEach(id => {
            const i = getUserInfo(id);
            if(i.name) {
                const opt = document.createElement('option');
                opt.value = id; opt.text = i.name;
                sel.appendChild(opt);
            }
        });
    }

    async function loginAdmin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const snap = await db.ref('settings/admin_password').once('value');
        const dbPass = snap.val() || 'admin';

        if (u === 'UTC' && p === dbPass) {
            currentRole = 'Admin';
            enterApp('Qu·∫£n Tr·ªã Vi√™n', 'Admin', 'view-admin');
            openTab('dashboard'); // M·∫∑c ƒë·ªãnh v√†o Dashboard
            document.getElementById('mobile-nav').style.display = 'flex'; // Hi·ªán bottom nav
        } else {
            alert('‚ùå Sai th√¥ng tin ƒëƒÉng nh·∫≠p');
        }
    }

    function loginEmp() {
        const id = document.getElementById('login-select').value;
        if (!id) return alert('Vui l√≤ng ch·ªçn t√™n');
        const info = getUserInfo(id);
        currentRole = 'Emp';
        enterApp(info.name, 'Nh√¢n Vi√™n', 'view-emp');
        loadEmpHistory(id);
        document.getElementById('mobile-nav').style.display = 'none'; // ·∫®n nav admin
    }

    function enterApp(name, role, viewId) {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('display-name').innerText = name;
        document.getElementById('display-role').innerText = role;
        document.getElementById('view-emp').classList.add('hidden');
        document.getElementById('view-admin').classList.add('hidden');
        document.getElementById(viewId).classList.remove('hidden');
    }

    // --- ADMIN TABS LOGIC ---
    function openTab(tabName, btnElement) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        
        // Update PC Sidebar
        document.querySelectorAll('.sidebar .nav-link').forEach(el => el.classList.remove('active'));
        // Update Mobile Bottom Nav
        document.querySelectorAll('.b-nav-item').forEach(el => el.classList.remove('active'));

        // Find and activate buttons (Logic h∆°i th·ªß c√¥ng ƒë·ªÉ map ƒë√∫ng)
        if(tabName === 'dashboard') {
             document.querySelector('.sidebar .nav-link:nth-child(2)').classList.add('active');
             document.querySelector('.bottom-nav .b-nav-item:nth-child(1)').classList.add('active');
             updateDashboard();
        }
        if(tabName === 'live') {
             document.querySelector('.sidebar .nav-link:nth-child(3)').classList.add('active');
             document.querySelector('.bottom-nav .b-nav-item:nth-child(2)').classList.add('active');
             loadMonitor();
        }
        if(tabName === 'salary') {
             document.querySelector('.sidebar .nav-link:nth-child(4)').classList.add('active');
             document.querySelector('.bottom-nav .b-nav-item:nth-child(3)').classList.add('active');
        }
        if(tabName === 'users') {
             document.querySelector('.sidebar .nav-link:nth-child(5)').classList.add('active');
             document.querySelector('.bottom-nav .b-nav-item:nth-child(4)').classList.add('active');
             renderUserList();
        }
    }

    // --- TAB 1: DASHBOARD ---
    async function updateDashboard() {
        const snap = await db.ref('attendance').limitToLast(100).once('value');
        const data = snap.val() || {};
        const logs = Object.values(data);
        const workTime = "08:00:00"; 
        
        let late = 0, onTime = 0, daysCount = {};
        logs.forEach(log => {
            const [date, time] = log.timestamp.split(' ');
            if (time > workTime) late++; else onTime++;
            daysCount[date] = (daysCount[date] || 0) + 1;
        });

        if(chartPie) chartPie.destroy();
        chartPie = new Chart(document.getElementById('chartPie'), {
            type: 'doughnut',
            data: { labels: ['ƒê√∫ng Gi·ªù', 'ƒêi Mu·ªôn'], datasets: [{ data: [onTime, late], backgroundColor: ['#10b981', '#f59e0b'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });

        if(chartBar) chartBar.destroy();
        const labels = Object.keys(daysCount).slice(-5);
        chartBar = new Chart(document.getElementById('chartBar'), {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'L∆∞·ª£t', data: labels.map(d=>daysCount[d]), backgroundColor: '#4f46e5', borderRadius: 5 }] },
            options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    // --- TAB 2: MONITOR ---
    function loadMonitor() {
        db.ref('attendance').limitToLast(50).on('value', snap => {
            const tbody = document.getElementById('live-body');
            tbody.innerHTML = "";
            const data = snap.val();
            if (!data) { tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>"; return; }
            
            const workTime = document.getElementById('work-time').value + ":00";

            Object.entries(data).reverse().forEach(([key, log]) => {
                const info = getUserInfo(log.id);
                const timeOnly = log.timestamp.split(' ')[1];
                const isLate = timeOnly > workTime;
                
                let nameHtml = info.name ? `<b>${info.name}</b>` : `<span class="badge badge-yellow">Ch∆∞a ƒêK</span>`;
                if(log.auto_generated) nameHtml += ` <i class="fa-solid fa-bolt" style="color:#f59e0b; font-size:0.7rem"></i>`;
                
                let codeDisplay = info.code !== "---" ? `<span class="badge badge-code">${info.code}</span>` : `<span class="badge badge-id">ID: ${log.id}</span>`;
                let statusHtml = isLate ? `<span class="badge badge-red">Mu·ªôn</span>` : `<span class="badge badge-green">OK</span>`;
                
                // N√∫t Th√™m nhanh cho ng∆∞·ªùi l·∫°
                let actionBtn = `<button class="btn btn-danger" style="padding:5px 10px" onclick="if(confirm('X√≥a?')) db.ref('attendance/${key}').remove()"><i class="fa-solid fa-trash"></i></button>`;
                if(!info.name) {
                    actionBtn = `<button class="btn btn-soft" style="padding:5px 10px; margin-right:5px" onclick="quickAdd('${log.id}')"><i class="fa-solid fa-user-plus"></i></button>` + actionBtn;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${log.timestamp.split(' ')[1]} <div style="font-size:0.7rem; color:#888">${log.timestamp.split(' ')[0]}</div></td>
                        <td>${codeDisplay}</td>
                        <td>${nameHtml}</td>
                        <td>${statusHtml}</td>
                        <td>${actionBtn}</td>
                    </tr>`;
            });
        });
    }
    function quickAdd(id) { openTab('users'); document.getElementById('inp-id').value = id; document.getElementById('inp-code').focus(); }

    // --- TAB 3: SALARY ---
    async function calcSalary() {
        const mInput = document.getElementById('month-filter').value;
        const salary = document.getElementById('salary-val').value;
        if (!mInput) return alert('Vui l√≤ng ch·ªçn th√°ng');
        const [yF, mF] = mInput.split('-');

        const snap = await db.ref('attendance').once('value');
        const data = snap.val();
        const tbody = document.getElementById('salary-table').querySelector('tbody');
        tbody.innerHTML = "";
        let total = 0;
        let stats = {};

        if (data) {
            Object.values(data).forEach(log => {
                let dStr = log.timestamp.split(' ')[0];
                let y, m, d;
                if(dStr.includes('-')) [y,m,d] = dStr.split('-'); else [d,m,y] = dStr.split('/');
                
                if (parseInt(y) == parseInt(yF) && parseInt(m) == parseInt(mF)) {
                    if(!stats[log.id]) stats[log.id] = new Set();
                    stats[log.id].add(d);
                }
            });
        }

        let reportData = [];
        Object.keys(stats).forEach(id => {
            const info = getUserInfo(id);
            if (!info.name || !info.code || info.code === "---") return; // B·ªè qua ng∆∞·ªùi l·∫°

            const days = stats[id].size;
            const money = days * salary;
            total += money;
            reportData.push({ "M√£": info.code, "T√™n": info.name, "C√¥ng": days, "Ti·ªÅn": money });
            
            tbody.innerHTML += `<tr><td><span class="badge badge-code">${info.code}</span></td><td>${info.name}</td><td><b>${days}</b></td><td style="color:var(--success)">${money.toLocaleString()}</td></tr>`;
        });
        document.getElementById('total-money').innerText = total.toLocaleString() + ' ƒë';
        window.tempReportData = reportData; // L∆∞u t·∫°m ƒë·ªÉ xu·∫•t excel
    }

    function exportExcel() {
        if(!window.tempReportData || window.tempReportData.length === 0) return alert('H√£y b·∫•m T√≠nh l∆∞∆°ng tr∆∞·ªõc');
        const ws = XLSX.utils.json_to_sheet(window.tempReportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BangLuong");
        XLSX.writeFile(wb, "BangLuong.xlsx");
    }
    
    async function deleteMonth() {
        const mInput = document.getElementById('month-filter').value;
        if(!mInput || !confirm('C·∫¢NH B√ÅO: X√≥a to√†n b·ªô d·ªØ li·ªáu th√°ng n√†y?')) return;
        const [yF, mF] = mInput.split('-');
        
        const snap = await db.ref('attendance').once('value');
        const data = snap.val();
        if(data) {
            let updates = {};
            Object.entries(data).forEach(([k, log]) => {
                let dStr = log.timestamp.split(' ')[0];
                let y, m;
                if(dStr.includes('-')) [y,m] = dStr.split('-'); else [_,m,y] = dStr.split('/');
                if(parseInt(y)==parseInt(yF) && parseInt(m)==parseInt(mF)) updates['attendance/'+k] = null;
            });
            await db.ref().update(updates);
            alert('ƒê√£ x√≥a d·ªØ li·ªáu th√†nh c√¥ng.');
            document.getElementById('salary-table').querySelector('tbody').innerHTML = "";
        }
    }

    // --- TAB 4: USERS ---
    function renderUserList() {
        const tbody = document.querySelector('#users-list tbody');
        tbody.innerHTML = "";
        Object.keys(usersCache).forEach(id => {
            const info = getUserInfo(id);
            tbody.innerHTML += `<tr onclick="fillForm('${id}')" style="cursor:pointer"><td><span class="badge badge-id">${id}</span></td><td>${info.code}</td><td>${info.name}</td></tr>`;
        });
    }
    function fillForm(id) {
        const info = getUserInfo(id);
        document.getElementById('inp-id').value = id;
        document.getElementById('inp-code').value = info.code !== "---" ? info.code : "";
        document.getElementById('inp-name').value = info.name;
        document.getElementById('btn-del-user').classList.remove('hidden');
    }
    function saveUser() {
        const id = document.getElementById('inp-id').value;
        const name = document.getElementById('inp-name').value;
        const code = document.getElementById('inp-code').value;
        if(!id || !name) return alert('Thi·∫øu th√¥ng tin');
        
        // Validate Code
        for(const [k, v] of Object.entries(usersCache)) {
             if(k !== id && v.code && code && v.code.toUpperCase() === code.toUpperCase()) return alert('Tr√πng M√£ NV');
        }

        db.ref('users/'+id).set({ name, code }).then(() => { alert('ƒê√£ l∆∞u'); resetForm(); });
    }
    function delUser() {
        if(confirm('X√≥a nh√¢n vi√™n n√†y?')) { db.ref('users/'+document.getElementById('inp-id').value).remove(); resetForm(); }
    }
    function resetForm() {
        document.getElementById('inp-id').value=""; document.getElementById('inp-name').value=""; document.getElementById('inp-code').value="";
        document.getElementById('btn-del-user').classList.add('hidden');
    }

    // --- EMP VIEW ---
    function loadEmpHistory(id) {
        db.ref('attendance').limitToLast(50).on('value', snap => {
            const tb = document.querySelector('#emp-table tbody');
            tb.innerHTML = "";
            const data = snap.val();
            if(data) Object.values(data).reverse().forEach(log => {
                if(log.id == id) tb.innerHTML += `<tr><td>${log.timestamp}</td><td><span class="badge badge-green">Th√†nh c√¥ng</span></td></tr>`;
            });
        });
    }

    // INIT DATE
    const d = new Date();
    document.getElementById('month-filter').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
</script>
</body>
</html>
