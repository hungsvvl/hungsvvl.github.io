<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ch·∫•m C√¥ng Chuy√™n Nghi·ªáp v2</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb; --bg-body: #f1f5f9; --bg-card: #ffffff;
            --text-main: #1e293b; --text-sub: #64748b;
            --success: #10b981; --danger: #ef4444;
        }

        body { font-family: 'Roboto', sans-serif; background: var(--bg-body); margin: 0; padding: 0; color: var(--text-main); }
        
        /* LOGIN */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 16px; width: 380px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center;
        }
        .login-tabs { display: flex; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; }
        .login-tab { flex: 1; padding: 12px; cursor: pointer; color: var(--text-sub); font-weight: 600; transition: 0.3s; }
        .login-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .login-form { display: none; animation: fadeIn 0.3s; }
        .login-form.active { display: block; }
        
        /* MAIN UI */
        .app-container { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .app-container.active { display: block; }

        .header-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--primary); color: white; padding: 15px 25px; 
            border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .card { 
            background: var(--bg-card); padding: 25px; border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px; border: 1px solid #e2e8f0;
        }
        .card h4 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 20px; }

        input, button, select { width: 100%; padding: 12px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; font-size: 14px; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        button { cursor: pointer; font-weight: 600; border: none; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; } 

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8fafc; color: var(--text-sub); font-weight: 700; text-transform: uppercase; font-size: 0.85em; padding: 15px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); }
        tr:hover { background-color: #f8fafc; }
        
        .admin-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-item { 
            padding: 12px 20px; background: white; border-radius: 8px; cursor: pointer; 
            font-weight: 600; color: var(--text-sub); border: 1px solid #e2e8f0; transition: 0.2s;
        }
        .nav-item.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* POPUP */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 16px; width: 400px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: slideDown 0.4s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .view-section { display: none; }
        .view-section.active { display: block; }
        
        .badge-id { background:#e0f2fe; color:#0284c7; padding:2px 6px; border-radius:4px; font-weight:bold; font-size: 0.9em; }
        .badge-code { background:#f0fdf4; color:#15803d; padding:2px 6px; border-radius:4px; font-weight:bold; border: 1px solid #bbf7d0; font-size: 0.9em;}
    </style>
</head>
<body>

<div id="new-id-modal" class="modal-overlay">
    <div class="modal-box">
        <h2 style="color: var(--primary); margin:0">üîî Ph√°t hi·ªán V√¢n Tay M·ªõi</h2>
        <p>ID Thi·∫øt B·ªã: <strong id="modal-id-display" style="font-size: 1.5em; color: var(--danger)">--</strong></p>
        <p>B·∫°n c√≥ mu·ªën th√™m nh√¢n vi√™n n√†y ngay kh√¥ng?</p>
        <div class="btn-group" style="justify-content: center;">
            <button class="btn-success" onclick="acceptNewID()" style="width: auto;">C√≥, Th√™m ngay</button>
            <button class="btn-danger" onclick="closeNewIDModal()" style="width: auto;">B·ªè qua</button>
        </div>
    </div>
</div>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color:var(--primary); margin-top:0">CH·∫§M C√îNG UTC</h2>
        <div class="login-tabs">
            <div class="login-tab active" onclick="switchLoginTab('emp')">Nh√¢n Vi√™n</div>
            <div class="login-tab" onclick="switchLoginTab('admin')">Qu·∫£n Tr·ªã</div>
        </div>

        <div id="login-form-emp" class="login-form active">
            <p style="text-align:left; font-size:0.9em; color:#666; margin-bottom:5px">Ch·ªçn t√™n c·ªßa b·∫°n:</p>
            <select id="login-emp-select">
                <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
            </select>
            <button class="btn-primary" onclick="loginAsEmployee()">Xem L·ªãch S·ª≠</button>
        </div>

        <div id="login-form-admin" class="login-form">
            <input type="text" id="login-admin-user" placeholder="T√™n ƒëƒÉng nh·∫≠p (UTC)">
            <input type="password" id="login-admin-pass" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-primary" onclick="loginAsAdmin()">ƒêƒÉng Nh·∫≠p Admin</button>
        </div>
        <div id="login-error" style="color:var(--danger); display:none; margin-top:10px; font-size:0.9em"></div>
    </div>
</div>

<div id="main-app" class="app-container">
    <div class="header-bar">
        <div>
            <h3 style="margin:0; font-size: 1.2em" id="welcome-msg">Xin ch√†o</h3>
            <span id="role-badge" style="background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:4px; font-size:0.8em">User</span>
        </div>
        <button class="logout-btn" onclick="logout()">ƒêƒÉng Xu·∫•t ‚ûî</button>
    </div>

    <div id="view-employee" class="view-section">
        <div class="card">
            <h4>üìÖ L·ªãch S·ª≠ Ch·∫•m C√¥ng C·ªßa B·∫°n</h4>
            <table>
                <thead><tr><th>Th·ªùi Gian</th><th>M√£ NV</th><th>Tr·∫°ng Th√°i</th></tr></thead>
                <tbody id="emp-history-body"><tr><td colspan="3">ƒêang t·∫£i...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="view-admin" class="view-section">
        <div class="admin-nav">
            <div class="nav-item active" onclick="switchAdminTab('live', this)">üìä Gi√°m S√°t</div>
            <div class="nav-item" onclick="switchAdminTab('report', this)">üí∞ T√≠nh L∆∞∆°ng</div>
            <div class="nav-item" onclick="switchAdminTab('manage', this)">üë• Nh√¢n S·ª±</div>
        </div>

        <div id="adm-tab-live" class="view-section active">
            <div class="card">
                <h4>üî¥ Ho·∫°t ƒê·ªông Th·ªùi Gian Th·ª±c</h4>
                <table>
                    <thead>
                        <tr>
                            <th width="25%">Th·ªùi Gian</th>
                            <th width="10%">ID V√¢n Tay</th>
                            <th width="15%">M√£ NV</th>
                            <th>H·ªç T√™n</th>
                            <th width="10%" style="text-align:center">X√≥a</th>
                        </tr>
                    </thead>
                    <tbody id="adm-live-body"></tbody>
                </table>
            </div>
        </div>

        <div id="adm-tab-report" class="view-section">
            <div class="card">
                <h4>B·ªô L·ªçc & T√≠nh To√°n</h4>
                <div style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom: 15px;">
                    <div style="flex:1"><label><b>Th√°ng:</b></label><input type="month" id="filter-month"></div>
                    <div style="flex:1"><label><b>L∆∞∆°ng/Ng√†y:</b></label><input type="number" id="salary-input" value="500000"></div>
                </div>
                <div class="btn-group">
                    <button class="btn-primary" onclick="calcSalary()">üîç T√≠nh L∆∞∆°ng</button>
                    <button class="btn-success" onclick="exportExcel()">üì• Xu·∫•t Excel</button>
                    <button class="btn-danger" onclick="deleteMonthData()">üóëÔ∏è X√≥a Th√°ng N√†y</button>
                </div>
            </div>
            <div class="card">
                <table id="salary-table">
                    <thead><tr><th>M√£ NV</th><th>H·ªç T√™n</th><th>Ng√†y C√¥ng</th><th>Th·ª±c Lƒ©nh</th></tr></thead>
                    <tbody id="salary-body"><tr><td colspan="4" style="text-align:center">Ch·ªçn th√°ng ƒë·ªÉ xem d·ªØ li·ªáu</td></tr></tbody>
                </table>
                <h3 style="text-align:right; margin-top:20px; color:var(--success)">T·ªïng Chi: <span id="total-payout">0 ƒë</span></h3>
            </div>
        </div>

        <div id="adm-tab-manage" class="view-section">
            <div style="display:flex; gap:20px; flex-wrap: wrap;">
                <div class="card" style="flex:1; min-width: 300px;">
                    <h4>üìù Th√¥ng Tin Nh√¢n Vi√™n</h4>
                    <label>ID V√¢n Tay (T·ª´ thi·∫øt b·ªã):</label>
                    <input type="number" id="inp-id" placeholder="VD: 1, 2, 3...">
                    
                    <label>M√£ Nh√¢n Vi√™n (Qu·∫£n l√Ω):</label>
                    <input type="text" id="inp-code" placeholder="VD: NV001, KD02...">
                    
                    <label>H·ªç v√† T√™n:</label>
                    <input type="text" id="inp-name" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n">
                    
                    <button class="btn-primary" onclick="saveUser()">üíæ L∆∞u Th√¥ng Tin</button>
                    <button class="btn-danger" id="btn-delete" style="display:none; margin-top:10px" onclick="deleteUser()">üóëÔ∏è X√≥a Nh√¢n Vi√™n N√†y</button>
                </div>

                <div class="card" style="flex:2; min-width: 300px;">
                    <h4>Danh S√°ch Nh√¢n Vi√™n</h4>
                    <div style="max-height:450px; overflow-y:auto">
                        <table id="user-list-table">
                            <thead><tr><th>ID</th><th>M√£ NV</th><th>H·ªç T√™n</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= 1. C·∫§U H√åNH FIREBASE =================
    const firebaseConfig = {
        apiKey: "HAY_DIEN_API_KEY_CUA_BAN_VAO_DAY", 
        authDomain: "quanlychamcong-9dacd.firebaseapp.com",
        databaseURL: "https://quanlychamcong-9dacd-default-rtdb.firebaseio.com",
        projectId: "quanlychamcong-9dacd",
        storageBucket: "quanlychamcong-9dacd.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ================= 2. BI·∫æN TO√ÄN C·ª§C =================
    let usersCache = {}; // C·∫•u tr√∫c m·ªõi: { id: { name: "A", code: "NV01" } }
    let reportData = [];
    let newIDDetected = null;

    // Load User Ngay khi m·ªü trang ƒë·ªÉ ƒë·ªï v√†o Dropdown
    db.ref('users').on('value', snap => {
        usersCache = snap.val() || {};
        renderLoginDropdown(); // C·∫≠p nh·∫≠t dropdown ƒëƒÉng nh·∫≠p
        if(document.getElementById('view-admin').style.display === 'block') {
            renderUserList(); // C·∫≠p nh·∫≠t danh s√°ch admin
        }
    });

    // ================= 3. X·ª¨ L√ù S·ª∞ KI·ªÜN ID M·ªöI =================
    db.ref('new_enroll').on('value', snap => {
        const val = snap.val();
        if (val) {
            newIDDetected = val;
            document.getElementById('modal-id-display').innerText = val;
            document.getElementById('new-id-modal').style.display = 'flex';
        } else {
            document.getElementById('new-id-modal').style.display = 'none';
        }
    });

    function acceptNewID() {
        document.getElementById('new-id-modal').style.display = 'none';
        // Chuy·ªÉn sang tab qu·∫£n l√Ω n·∫øu ƒëang ·ªü Admin
        if(document.getElementById('view-admin').style.display !== 'none') { 
            switchAdminTab('manage', document.querySelectorAll('.nav-item')[2]);
            document.getElementById('inp-id').value = newIDDetected;
            document.getElementById('inp-code').focus(); // Focus v√†o √¥ M√£ NV
        }
        db.ref('new_enroll').remove();
    }
    function closeNewIDModal() {
        db.ref('new_enroll').remove();
        document.getElementById('new-id-modal').style.display = 'none';
    }

    // ================= 4. LOGIC ƒêƒÇNG NH·∫¨P & APP =================
    function switchLoginTab(type) {
        document.querySelectorAll('.login-tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.login-form').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`login-form-${type}`).classList.add('active');
        document.getElementById('login-error').style.display = 'none';
    }

    // Render danh s√°ch nh√¢n vi√™n v√†o Dropdown Select
    function renderLoginDropdown() {
        const select = document.getElementById('login-emp-select');
        select.innerHTML = '<option value="">-- Ch·ªçn t√™n c·ªßa b·∫°n --</option>';
        
        Object.keys(usersCache).forEach(id => {
            const u = usersCache[id];
            // X·ª≠ l√Ω t∆∞∆°ng th√≠ch d·ªØ li·ªáu c≈© (ch·ªâ c√≥ t√™n) v√† m·ªõi (object)
            const name = (typeof u === 'object') ? u.name : u;
            const code = (typeof u === 'object' && u.code) ? `(${u.code})` : `(ID:${id})`;
            
            const option = document.createElement('option');
            option.value = id;
            option.text = `${name} ${code}`;
            select.appendChild(option);
        });
    }

    function loginAsEmployee() {
        const id = document.getElementById('login-emp-select').value;
        if (!id) return showError("Vui l√≤ng ch·ªçn t√™n c·ªßa b·∫°n!");
        
        const u = usersCache[id];
        const name = (typeof u === 'object') ? u.name : u;

        setupApp(name, 'Nh√¢n Vi√™n', 'view-employee');
        loadEmployeeData(id);
    }

    function loginAsAdmin() {
        const u = document.getElementById('login-admin-user').value;
        const p = document.getElementById('login-admin-pass').value;
        if (u === "UTC" && p === "admin") {
            setupApp('Qu·∫£n Tr·ªã Vi√™n', 'Admin', 'view-admin');
            loadAdminData();
        } else {
            showError("Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!");
        }
    }

    function setupApp(name, role, viewId) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-app').classList.add('active');
        document.getElementById('welcome-msg').innerText = "Xin ch√†o, " + name;
        document.getElementById('role-badge').innerText = role;
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        document.getElementById(viewId).style.display = 'block';
        if(role === 'Admin') document.getElementById('adm-tab-live').style.display = 'block';
    }

    function showError(msg) {
        const el = document.getElementById('login-error');
        el.innerText = msg;
        el.style.display = 'block';
    }
    function logout() { location.reload(); }

    // ================= 5. LOGIC ADMIN =================
    function switchAdminTab(tabName, btnElement) {
        document.querySelectorAll('.view-section').forEach(el => {
            if(el.id.startsWith('adm-tab')) el.style.display = 'none';
        });
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        
        if(btnElement) btnElement.classList.add('active');
        document.getElementById('adm-tab-' + tabName).style.display = 'block';
    }

    // --- Tab Gi√°m S√°t ---
    function loadAdminData() {
        db.ref('attendance').limitToLast(50).on('value', snap => {
            const tbody = document.getElementById('adm-live-body');
            tbody.innerHTML = "";
            const data = snap.val();
            if(!data) { tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>"; return; }
            
            Object.entries(data).reverse().forEach(([key, log]) => {
                const user = usersCache[log.id];
                const name = user ? ((typeof user === 'object') ? user.name : user) : "Ch∆∞a ƒë·∫∑t t√™n";
                const code = (user && typeof user === 'object' && user.code) ? user.code : "--";

                tbody.innerHTML += `
                    <tr>
                        <td>${log.timestamp}</td>
                        <td><span class="badge-id">${log.id}</span></td>
                        <td><span class="badge-code">${code}</span></td>
                        <td><b>${name}</b></td>
                        <td style="text-align:center"><button class="btn-danger" style="padding:4px 8px; font-size:0.8em" onclick="deleteLog('${key}')">üóëÔ∏è</button></td>
                    </tr>`;
            });
        });
    }

    function deleteLog(key) {
        if(confirm("X√≥a d√≤ng n√†y?")) db.ref('attendance/' + key).remove();
    }

    // --- Tab Qu·∫£n L√Ω Nh√¢n S·ª± ---
    function renderUserList() {
        const tbody = document.querySelector('#user-list-table tbody');
        tbody.innerHTML = "";
        Object.keys(usersCache).forEach(id => {
            const u = usersCache[id];
            const name = (typeof u === 'object') ? u.name : u;
            const code = (typeof u === 'object' && u.code) ? u.code : "";
            
            tbody.innerHTML += `<tr onclick="editUser('${id}', '${name}', '${code}')" style="cursor:pointer">
                <td><span class="badge-id">${id}</span></td>
                <td><span class="badge-code">${code}</span></td>
                <td>${name}</td>
            </tr>`;
        });
    }

    function saveUser() {
        const id = document.getElementById('inp-id').value;
        const name = document.getElementById('inp-name').value;
        const code = document.getElementById('inp-code').value;

        if(id && name) {
            // L∆∞u d·∫°ng Object g·ªìm T√™n v√† M√£ NV
            db.ref('users/' + id).set({
                name: name,
                code: code
            });
            alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
            resetForm();
        } else {
            alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t ID v√† T√™n!");
        }
    }
    
    function deleteUser() {
        const id = document.getElementById('inp-id').value;
        if(confirm("X√≥a nh√¢n vi√™n n√†y?")) {
            db.ref('users/' + id).remove();
            resetForm();
        }
    }

    function editUser(id, name, code) {
        document.getElementById('inp-id').value = id;
        document.getElementById('inp-name').value = name;
        document.getElementById('inp-code').value = code;
        document.getElementById('btn-delete').style.display = 'inline-block';
    }

    function resetForm() {
        document.getElementById('inp-id').value = "";
        document.getElementById('inp-name').value = "";
        document.getElementById('inp-code').value = "";
        document.getElementById('btn-delete').style.display = 'none';
    }

    // ================= 6. T√çNH L∆Ø∆†NG & EXCEL VI·ªÜT H√ìA =================
    async function calcSalary() {
        const monthInput = document.getElementById('filter-month').value;
        const salary = document.getElementById('salary-input').value;
        if(!monthInput) return alert("Vui l√≤ng ch·ªçn th√°ng!");

        const [yFilter, mFilter] = monthInput.split('-');
        const tbody = document.getElementById('salary-body');
        tbody.innerHTML = "<tr><td colspan='4'>ƒêang t√≠nh to√°n...</td></tr>";

        const snap = await db.ref('attendance').once('value');
        const data = snap.val();
        
        if(!data) { tbody.innerHTML = "<tr><td colspan='4'>Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>"; return; }

        let stats = {};
        let countFound = 0;

        Object.values(data).forEach(log => {
            let dateStr = log.timestamp.split(' ')[0]; 
            let yLog, mLog, dLog;
            if(dateStr.includes('-')) { [yLog, mLog, dLog] = dateStr.split('-'); }
            else { [dLog, mLog, yLog] = dateStr.split('/'); }

            if(parseInt(yLog) === parseInt(yFilter) && parseInt(mLog) === parseInt(mFilter)) {
                if(!stats[log.id]) stats[log.id] = new Set();
                stats[log.id].add(dLog);
                countFound++;
            }
        });

        tbody.innerHTML = "";
        reportData = []; // Reset d·ªØ li·ªáu excel
        let total = 0;

        if(countFound === 0) {
            tbody.innerHTML = `<tr><td colspan='4' style='color:red'>Kh√¥ng c√≥ d·ªØ li·ªáu th√°ng ${mFilter}/${yFilter}</td></tr>`; return;
        }

        Object.keys(stats).forEach(id => {
            const days = stats[id].size;
            const money = days * salary;
            
            // L·∫•y th√¥ng tin user
            const u = usersCache[id];
            const name = u ? ((typeof u === 'object') ? u.name : u) : "Ch∆∞a ƒë·∫∑t t√™n";
            const code = (u && typeof u === 'object' && u.code) ? u.code : "";

            total += money;

            // D·ªØ li·ªáu Xu·∫•t Excel (Ti·∫øng Vi·ªát)
            reportData.push({
                "M√£ Nh√¢n Vi√™n": code,
                "H·ªç v√† T√™n": name,
                "ID V√¢n Tay": id,
                "S·ªë Ng√†y C√¥ng": days,
                "L∆∞∆°ng C∆° B·∫£n": salary,
                "Th·ª±c Lƒ©nh (VNƒê)": money
            });

            tbody.innerHTML += `<tr>
                <td><span class="badge-code">${code}</span></td>
                <td>${name}</td>
                <td style="font-weight:bold">${days}</td>
                <td style="color:var(--success); font-weight:bold">${money.toLocaleString()} ƒë</td>
            </tr>`;
        });
        document.getElementById('total-payout').innerText = total.toLocaleString() + " ƒë";
    }

    function exportExcel() {
        if(reportData.length == 0) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BangLuong");
        XLSX.writeFile(wb, "BangLuong_ChiTiet.xlsx");
    }

    async function deleteMonthData() {
        const monthInput = document.getElementById('filter-month').value;
        if(!monthInput) return alert("Ch·ªçn th√°ng!");
        const [yFilter, mFilter] = monthInput.split('-');

        if(!confirm(`C·∫¢NH B√ÅO: X√≥a to√†n b·ªô d·ªØ li·ªáu th√°ng ${mFilter}/${yFilter}?`)) return;
        const code = Math.floor(1000 + Math.random() * 9000);
        if(prompt(`Nh·∫≠p m√£ "${code}" ƒë·ªÉ x√°c nh·∫≠n x√≥a:`) != code) return alert("M√£ sai.");

        const snap = await db.ref('attendance').once('value');
        const data = snap.val();
        if(!data) return alert("Kh√¥ng c√≥ g√¨ ƒë·ªÉ x√≥a.");

        let updates = {};
        Object.entries(data).forEach(([key, log]) => {
            let dateStr = log.timestamp.split(' ')[0];
            let yLog, mLog;
            if(dateStr.includes('-')) { [yLog, mLog] = dateStr.split('-'); }
            else { [_, mLog, yLog] = dateStr.split('/'); }

            if(parseInt(yLog) === parseInt(yFilter) && parseInt(mLog) === parseInt(mFilter)) {
                updates['attendance/' + key] = null;
            }
        });
        await db.ref().update(updates);
        alert("ƒê√£ x√≥a xong!");
        document.getElementById('salary-body').innerHTML = "";
    }

    // ================= 7. LOGIC NH√ÇN VI√äN =================
    function loadEmployeeData(myId) {
        const tbody = document.getElementById('emp-history-body');
        const u = usersCache[myId];
        const myCode = (u && typeof u === 'object') ? u.code : "--";

        db.ref('attendance').limitToLast(100).on('value', snap => {
            tbody.innerHTML = "";
            const data = snap.val();
            if(!data) return;
            Object.values(data).reverse().forEach(log => {
                if(log.id == myId) {
                    tbody.innerHTML += `<tr><td>${log.timestamp}</td><td><span class="badge-code">${myCode}</span></td><td style="color:var(--success)">‚úî Th√†nh c√¥ng</td></tr>`;
                }
            });
        });
    }

    // M·∫∑c ƒë·ªãnh th√°ng hi·ªán t·∫°i
    const d = new Date();
    document.getElementById('filter-month').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
</script>

</body>
</html>
