<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ch·∫•m C√¥ng V5 (Check Tr√πng)</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --white: #ffffff; --text: #1e293b; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); }
        
        /* LOGIN */
        #login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a, #3b82f6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: var(--white); padding: 40px; border-radius: 16px; width: 380px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; cursor: pointer; color: #64748b; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .form { display: none; } .form.active { display: block; }
        
        /* MAIN APP */
        .app { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .app.active { display: block; }
        .header { background: var(--primary); color: var(--white); padding: 15px 25px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* ELEMENTS */
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; outline: none; }
        button { font-weight: bold; color: white; border: none; cursor: pointer; }
        .btn-blue { background: var(--primary); } .btn-green { background: var(--success); } .btn-red { background: var(--danger); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold; }
        .badge-id { background: #e0f2fe; color: #0284c7; }
        .badge-warn { background: #fee2e2; color: #ef4444; }
        .badge-new { background: #fef3c7; color: #d97706; border: 1px solid #fcd34d; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8fafc; padding: 12px; text-align: left; font-size: 0.9em; color: #64748b; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        
        /* ADMIN NAV */
        .nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-item { padding: 10px 20px; background: white; border-radius: 8px; cursor: pointer; border: 1px solid #e2e8f0; font-weight: bold; color: #64748b; }
        .nav-item.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* POPUP */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 400px; }
    </style>
</head>
<body>

<div id="new-id-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--primary)">üîî Ph√°t Hi·ªán ID M·ªõi</h2>
        <h1 id="modal-id" style="font-size:3em; margin:10px 0; color:var(--danger)">--</h1>
        <p>ƒê√£ t·ª± ƒë·ªông l∆∞u gi·ªù qu√©t v√†o l·ªãch s·ª≠.</p>
        <p>B·∫°n c√≥ mu·ªën ƒë·∫∑t t√™n cho nh√¢n vi√™n n√†y ngay?</p>
        <div style="display:flex; gap:10px">
            <button class="btn-green" onclick="acceptNewID()">ƒê·∫∑t T√™n Ngay</button>
            <button class="btn-red" onclick="closeModal()">ƒê·ªÉ Sau</button>
        </div>
    </div>
</div>

<div id="login-screen">
    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-top:0">CH·∫§M C√îNG UTC</h2>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('emp')">Nh√¢n Vi√™n</div>
                <div class="tab" onclick="switchTab('admin')">Qu·∫£n Tr·ªã</div>
            </div>

            <div id="form-emp" class="form active">
                <select id="login-select"><option>ƒêang t·∫£i danh s√°ch...</option></select>
                <button class="btn-blue" onclick="loginEmp()">Xem C√¥ng</button>
            </div>

            <div id="form-admin" class="form">
                <input type="text" id="user" placeholder="T√™n ƒëƒÉng nh·∫≠p (UTC)">
                <input type="password" id="pass" placeholder="M·∫≠t kh·∫©u">
                <button class="btn-blue" onclick="loginAdmin()">ƒêƒÉng Nh·∫≠p</button>
            </div>
        </div>
    </div>
</div>

<div id="app" class="app">
    <div class="header">
        <div>Xin ch√†o, <b id="user-name">Guest</b></div>
        <button class="btn-red" style="width:auto; padding:8px 15px" onclick="location.reload()">ƒêƒÉng Xu·∫•t</button>
    </div>

    <div id="view-emp" style="display:none">
        <div class="card">
            <h4>L·ªãch S·ª≠ C·ªßa B·∫°n</h4>
            <table id="emp-table"><thead><tr><th>Th·ªùi Gian</th><th>Tr·∫°ng Th√°i</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="view-admin" style="display:none">
        <div class="nav">
            <div class="nav-item active" onclick="openAdminTab('live', this)">Gi√°m S√°t</div>
            <div class="nav-item" onclick="openAdminTab('salary', this)">L∆∞∆°ng</div>
            <div class="nav-item" onclick="openAdminTab('users', this)">Nh√¢n S·ª±</div>
        </div>

        <div id="tab-live">
            <div class="card">
                <h4>Ho·∫°t ƒê·ªông G·∫ßn Nh·∫•t (Realtime)</h4>
                <table>
                    <thead><tr><th>Th·ªùi Gian</th><th>ID</th><th>M√£ NV</th><th>H·ªç T√™n</th><th>X√≥a</th></tr></thead>
                    <tbody id="live-body"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-salary" style="display:none">
            <div class="card">
                <div style="display:flex; gap:10px">
                    <input type="month" id="month-filter">
                    <input type="number" id="salary-val" value="500000">
                </div>
                <div style="display:flex; gap:10px; margin-top:10px">
                    <button class="btn-blue" onclick="calcSalary()">T√≠nh L∆∞∆°ng</button>
                    <button class="btn-green" onclick="exportExcel()">Xu·∫•t Excel</button>
                    <button class="btn-red" onclick="deleteMonth()">X√≥a Th√°ng N√†y</button>
                </div>
            </div>
            <div class="card">
                <h4>B·∫£ng L∆∞∆°ng</h4>
                <table id="salary-table"><thead><tr><th>M√£ NV</th><th>H·ªç T√™n</th><th>C√¥ng</th><th>Ti·ªÅn</th></tr></thead><tbody></tbody></table>
                <p style="text-align:right; font-weight:bold; font-size:1.2em; color:var(--success)">T·ªïng: <span id="total-money">0 ƒë</span></p>
            </div>
        </div>

        <div id="tab-users" style="display:none">
            <div style="display:flex; gap:20px; flex-wrap:wrap">
                <div class="card" style="flex:1">
                    <h4>Th√¥ng Tin Nh√¢n Vi√™n</h4>
                    <label>ID V√¢n Tay:</label><input type="number" id="inp-id" placeholder="VD: 1">
                    <label>M√£ NV:</label><input type="text" id="inp-code" placeholder="VD: NV01">
                    <label>H·ªç T√™n:</label><input type="text" id="inp-name" placeholder="T√™n nh√¢n vi√™n">
                    <button class="btn-blue" onclick="saveUser()">L∆∞u L·∫°i</button>
                    <button class="btn-red" id="btn-del-user" style="display:none; margin-top:10px" onclick="delUser()">X√≥a NV</button>
                </div>
                <div class="card" style="flex:2">
                    <h4>Danh S√°ch</h4>
                    <div style="max-height:400px; overflow-y:auto">
                        <table id="users-list"><thead><tr><th>ID</th><th>M√£</th><th>T√™n</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. C·∫§U H√åNH (Thay API KEY c·ªßa b·∫°n v√†o ƒë√¢y)
    const firebaseConfig = {
        apiKey: "HAY_DIEN_API_KEY_CUA_BAN_VAO_DAY", 
        authDomain: "quanlychamcong-9dacd.firebaseapp.com",
        databaseURL: "https://quanlychamcong-9dacd-default-rtdb.firebaseio.com",
        projectId: "quanlychamcong-9dacd",
        storageBucket: "quanlychamcong-9dacd.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // BI·∫æN TO√ÄN C·ª§C
    let usersCache = {};
    let reportData = [];
    let newID = null;
    let processedNewIDs = new Set();

    // H√ÄM L·∫§Y TH·ªúI GIAN
    function getCurrentDateTime() {
        const now = new Date();
        const d = String(now.getDate()).padStart(2, '0');
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const y = now.getFullYear();
        const h = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        return `${d}/${m}/${y} ${h}:${min}:${s}`;
    }

    // LOAD DATA
    db.ref('users').on('value', snap => {
        usersCache = snap.val() || {};
        renderLogin(); 
        if(document.getElementById('view-admin').style.display === 'block') renderUserList();
        loadMonitor(); 
    });

    // AUTO LOG & POPUP
    db.ref('new_enroll').on('value', snap => {
        const val = snap.val();
        if(val) {
            newID = val;
            if(!processedNewIDs.has(val)) {
                db.ref('attendance').push({
                    id: val,
                    timestamp: getCurrentDateTime(),
                    auto_generated: true
                });
                processedNewIDs.add(val);
            }
            document.getElementById('modal-id').innerText = newID;
            document.getElementById('new-id-modal').style.display = 'flex';
        } else {
            document.getElementById('new-id-modal').style.display = 'none';
        }
    });

    function acceptNewID() {
        closeModal();
        if(document.getElementById('view-admin').style.display !== 'none') {
            openAdminTab('users', document.querySelectorAll('.nav-item')[2]);
            document.getElementById('inp-id').value = newID;
            document.getElementById('inp-code').focus();
        }
        db.ref('new_enroll').remove();
    }
    
    function closeModal() { 
        document.getElementById('new-id-modal').style.display = 'none'; 
        db.ref('new_enroll').remove(); 
    }

    function getUserInfo(id) {
        const u = usersCache[id];
        if (!u) return { name: null, code: "---" };
        if (typeof u === 'string') return { name: u, code: "---" };
        return { name: u.name, code: u.code || "---" };
    }

    // LOGIN & UI
    function switchTab(t) {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.form').forEach(e=>e.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('form-'+t).classList.add('active');
    }

    function renderLogin() {
        const sel = document.getElementById('login-select');
        sel.innerHTML = '<option value="">-- Ch·ªçn t√™n b·∫°n --</option>';
        Object.keys(usersCache).forEach(id => {
            const info = getUserInfo(id);
            const opt = document.createElement('option');
            opt.value = id;
            opt.text = `${info.name} (ID:${id})`;
            sel.appendChild(opt);
        });
    }

    function loginAdmin() {
        if(document.getElementById('user').value == 'UTC' && document.getElementById('pass').value == 'admin') {
            enterApp('Qu·∫£n Tr·ªã Vi√™n', 'view-admin');
            openAdminTab('live', document.querySelector('.nav-item'));
            loadMonitor();
        } else alert('Sai m·∫≠t kh·∫©u');
    }

    function loginEmp() {
        const id = document.getElementById('login-select').value;
        if(!id) return alert('Ch·ªçn t√™n!');
        const info = getUserInfo(id);
        enterApp(info.name, 'view-emp');
        loadEmpHistory(id);
    }

    function enterApp(name, view) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').classList.add('active');
        document.getElementById('user-name').innerText = name;
        document.getElementById('view-emp').style.display = 'none';
        document.getElementById('view-admin').style.display = 'none';
        document.getElementById(view).style.display = 'block';
    }

    function openAdminTab(tab, btn) {
        document.getElementById('tab-live').style.display = 'none';
        document.getElementById('tab-salary').style.display = 'none';
        document.getElementById('tab-users').style.display = 'none';
        document.getElementById('tab-'+tab).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    // --- GI√ÅM S√ÅT ---
    function loadMonitor() {
        db.ref('attendance').limitToLast(50).on('value', snap => {
            const tbody = document.getElementById('live-body');
            tbody.innerHTML = "";
            const data = snap.val();
            if(!data) { tbody.innerHTML = "<tr><td colspan='5'>Ch∆∞a c√≥ log ch·∫•m c√¥ng</td></tr>"; return; }

            Object.entries(data).reverse().forEach(([key, log]) => {
                const info = getUserInfo(log.id);
                let nameDisplay = info.name ? `<b>${info.name}</b>` : `<span class="badge badge-warn">Ch∆∞a ƒëƒÉng k√Ω</span>`;
                if(log.auto_generated) nameDisplay += ` <span class="badge badge-new" style="font-size:0.7em">M·ªõi qu√©t</span>`;

                tbody.innerHTML += `
                    <tr>
                        <td>${log.timestamp}</td>
                        <td><span class="badge badge-id">${log.id}</span></td>
                        <td>${info.code}</td>
                        <td>${nameDisplay}</td>
                        <td><button class="btn-red" style="padding:4px 8px" onclick="delLog('${key}')">X√≥a</button></td>
                    </tr>`;
            });
        });
    }
    function delLog(k) { if(confirm('X√≥a?')) db.ref('attendance/'+k).remove(); }

    // --- NH√ÇN S·ª∞ & CHECK TR√ôNG (N√ÇNG C·∫§P) ---
    function renderUserList() {
        const tbody = document.querySelector('#users-list tbody');
        tbody.innerHTML = "";
        Object.keys(usersCache).forEach(id => {
            const info = getUserInfo(id);
            tbody.innerHTML += `
                <tr onclick="fillForm('${id}')" style="cursor:pointer">
                    <td><b>${id}</b></td>
                    <td>${info.code}</td>
                    <td>${info.name}</td>
                </tr>`;
        });
    }
    function fillForm(id) {
        const info = getUserInfo(id);
        document.getElementById('inp-id').value = id;
        document.getElementById('inp-code').value = info.code !== "---" ? info.code : "";
        document.getElementById('inp-name').value = info.name;
        document.getElementById('btn-del-user').style.display = 'inline-block';
    }

    function saveUser() {
        // 1. L·∫•y d·ªØ li·ªáu v√† lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a
        const id = document.getElementById('inp-id').value.trim();
        const name = document.getElementById('inp-name').value.trim();
        const code = document.getElementById('inp-code').value.trim();

        if (!id || !name) return alert('Vui l√≤ng nh·∫≠p ID v√† T√™n!');

        // 2. CHECK TR√ôNG M√É NH√ÇN VI√äN
        // Duy·ªát qua t·∫•t c·∫£ user hi·ªán c√≥ ƒë·ªÉ xem M√£ NV n√†y ƒë√£ c√≥ ai d√πng ch∆∞a
        for (const [key, val] of Object.entries(usersCache)) {
            // B·ªè qua n·∫øu ƒëang so s√°nh v·ªõi ch√≠nh user n√†y (tr∆∞·ªùng h·ª£p ƒëang Edit)
            if (key === id) continue;

            // L·∫•y m√£ c·ªßa user kh√°c (x·ª≠ l√Ω tr∆∞·ªùng h·ª£p d·ªØ li·ªáu c≈©/m·ªõi)
            const existingCode = (typeof val === 'object' && val.code) ? val.code : "";
            
            // So s√°nh (kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng)
            if (code !== "" && existingCode !== "" && code.toUpperCase() === existingCode.toUpperCase()) {
                alert(`‚õî L·ªñI: M√£ nh√¢n vi√™n '${code}' ƒë√£ b·ªã tr√πng!\nƒêang ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi: ${typeof val === 'object' ? val.name : val} (ID: ${key}).\nVui l√≤ng ch·ªçn m√£ kh√°c.`);
                return; // D·ª´ng l·∫°i, kh√¥ng cho l∆∞u
            }
        }

        // 3. CHECK TR√ôNG ID V√ÇN TAY (C·∫£nh b√°o ghi ƒë√®)
        if (usersCache[id]) {
            const currentInfo = getUserInfo(id);
            // N·∫øu ng∆∞·ªùi d√πng ƒëang b·∫•m n√∫t L∆∞u cho ID ƒë√£ t·ªìn t·∫°i, h·ªèi x√°c nh·∫≠n
            if(!confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO: ID ${id} ƒë√£ t·ªìn t·∫°i (${currentInfo.name}).\nB·∫°n c√≥ mu·ªën C·∫¨P NH·∫¨T th√¥ng tin m·ªõi cho ID n√†y kh√¥ng?`)) {
                return; // N·∫øu b·∫•m Cancel th√¨ d·ª´ng l·∫°i
            }
        }

        // 4. L∆ØU D·ªÆ LI·ªÜU
        db.ref('users/'+id).set({ name: name, code: code })
            .then(() => {
                alert('‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!');
                resetForm();
            })
            .catch(e => alert('L·ªói: ' + e));
    }

    function delUser() {
        const id = document.getElementById('inp-id').value;
        if(confirm('X√≥a nh√¢n vi√™n n√†y?')) {
            db.ref('users/'+id).remove();
            resetForm();
        }
    }
    function resetForm() {
        document.getElementById('inp-id').value = "";
        document.getElementById('inp-name').value = "";
        document.getElementById('inp-code').value = "";
        document.getElementById('btn-del-user').style.display = 'none';
    }

    // --- TAB L∆Ø∆†NG ---
    async function calcSalary() {
        const mInput = document.getElementById('month-filter').value;
        const salary = document.getElementById('salary-val').value;
        if(!mInput) return alert('Ch·ªçn th√°ng!');
        const [yF, mF] = mInput.split('-');

        const snap = await db.ref('attendance').once('value');
        const data = snap.val();
        const tbody = document.getElementById('salary-table').querySelector('tbody');
        tbody.innerHTML = "";
        reportData = [];
        let total = 0;

        if(!data) return tbody.innerHTML = "<tr><td colspan='4'>Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>";

        let stats = {};
        Object.values(data).forEach(log => {
            let dateStr = log.timestamp.split(' ')[0];
            let y, m, d;
            if(dateStr.includes('-')) [y, m, d] = dateStr.split('-');
            else [d, m, y] = dateStr.split('/');
            
            if(parseInt(y)==parseInt(yF) && parseInt(m)==parseInt(mF)) {
                if(!stats[log.id]) stats[log.id] = new Set();
                stats[log.id].add(d);
            }
        });

        Object.keys(stats).forEach(id => {
            const days = stats[id].size;
            const money = days * salary;
            total += money;
            const info = getUserInfo(id);
            
            reportData.push({"M√£ NV": info.code, "H·ªç T√™n": info.name, "Ng√†y C√¥ng": days, "L∆∞∆°ng": money});
            tbody.innerHTML += `<tr><td>${info.code}</td><td>${info.name || 'ID:'+id}</td><td><b>${days}</b></td><td>${money.toLocaleString()}</td></tr>`;
        });
        document.getElementById('total-money').innerText = total.toLocaleString() + ' ƒë';
    }
    
    function exportExcel() {
        if(!reportData.length) return alert('Ch∆∞a t√≠nh l∆∞∆°ng!');
        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Luong");
        XLSX.writeFile(wb, "BangLuong.xlsx");
    }

    async function deleteMonth() {
        if(!confirm('X√≥a d·ªØ li·ªáu th√°ng n√†y?')) return;
        const mInput = document.getElementById('month-filter').value;
        const [yF, mF] = mInput.split('-');
        
        const snap = await db.ref('attendance').once('value');
        const data = snap.val();
        if(!data) return;

        let updates = {};
        Object.entries(data).forEach(([k, log]) => {
            let dateStr = log.timestamp.split(' ')[0];
            let y, m;
            if(dateStr.includes('-')) [y, m] = dateStr.split('-');
            else [_, m, y] = dateStr.split('/');
            
            if(parseInt(y)==parseInt(yF) && parseInt(m)==parseInt(mF)) updates['attendance/'+k] = null;
        });
        await db.ref().update(updates);
        alert('ƒê√£ x√≥a!');
        document.getElementById('salary-table').querySelector('tbody').innerHTML = "";
    }

    function loadEmpHistory(id) {
        db.ref('attendance').limitToLast(50).on('value', snap => {
            const tb = document.querySelector('#emp-table tbody');
            tb.innerHTML = "";
            const data = snap.val();
            if(data) {
                Object.values(data).reverse().forEach(log => {
                    if(log.id == id) tb.innerHTML += `<tr><td>${log.timestamp}</td><td style="color:green">‚úî Th√†nh c√¥ng</td></tr>`;
                });
            }
        });
    }
    
    const d = new Date();
    document.getElementById('month-filter').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
</script>
</body>
</html>
