<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ch·∫•m C√¥ng Chuy√™n Nghi·ªáp</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;    /* Xanh d∆∞∆°ng ƒë·∫≠m */
            --bg-body: #f1f5f9;    /* X√°m n·ªÅn */
            --bg-card: #ffffff;    /* Tr·∫Øng n·ªÅn th·∫ª */
            --text-main: #1e293b;  /* ƒêen x√°m ch·ªØ */
            --text-sub: #64748b;   /* X√°m nh·∫°t ch·ªØ */
            --success: #10b981;    /* Xanh l√° */
            --danger: #ef4444;     /* ƒê·ªè */
        }

        body { font-family: 'Roboto', sans-serif; background: var(--bg-body); margin: 0; padding: 0; color: var(--text-main); }
        
        /* === 1. LOGIN SCREEN === */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 16px; width: 380px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center;
        }
        .login-tabs { display: flex; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; }
        .login-tab { flex: 1; padding: 12px; cursor: pointer; color: var(--text-sub); font-weight: 600; transition: 0.3s; }
        .login-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .login-form { display: none; animation: fadeIn 0.3s; }
        .login-form.active { display: block; }
        
        /* === 2. MAIN APP LAYOUT === */
        .app-container { display: none; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .app-container.active { display: block; }

        /* Header */
        .header-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--primary); color: white; padding: 15px 25px; 
            border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* Cards (Khung ch·ª©a n·ªôi dung) */
        .card { 
            background: var(--bg-card); padding: 25px; border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        .card h4 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 20px; }

        /* Inputs & Buttons */
        input, button, select { width: 100%; padding: 12px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; outline: none; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        button { cursor: pointer; font-weight: 600; border: none; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-group { display: flex; gap: 10px; } /* Nh√≥m n√∫t n·∫±m ngang */

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8fafc; color: var(--text-sub); font-weight: 700; text-transform: uppercase; font-size: 0.85em; padding: 15px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); }
        tr:hover { background-color: #f8fafc; }
        
        /* Admin Navigation */
        .admin-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-item { 
            padding: 12px 20px; background: white; border-radius: 8px; cursor: pointer; 
            font-weight: 600; color: var(--text-sub); border: 1px solid #e2e8f0; transition: 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .nav-item:hover { background: #f8fafc; }
        .nav-item.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3); }

        /* === POPUP TH√îNG B√ÅO ID M·ªöI === */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 16px; width: 400px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: slideDown 0.4s;
        }
        .modal-icon { font-size: 50px; margin-bottom: 15px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* ·∫®n hi·ªán c√°c View */
        .view-section { display: none; }
        .view-section.active { display: block; }
    </style>
</head>
<body>

<div id="new-id-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-icon">üîî</div>
        <h2 style="color: var(--primary); margin:0">Ph√°t hi·ªán V√¢n Tay M·ªõi!</h2>
        <p style="color: var(--text-sub)">H·ªá th·ªëng v·ª´a nh·∫≠n ƒë∆∞·ª£c t√≠n hi·ªáu t·ª´ ID:</p>
        <h1 id="modal-id-display" style="font-size: 3em; margin: 10px 0; color: var(--text-main)">--</h1>
        <p>B·∫°n c√≥ mu·ªën ƒë·∫∑t t√™n cho nh√¢n vi√™n n√†y ngay kh√¥ng?</p>
        <div class="btn-group">
            <button class="btn-success" onclick="acceptNewID()">‚úÖ C√≥, ƒê·∫∑t t√™n ngay</button>
            <button class="btn-danger" onclick="closeNewIDModal()">‚ùå Kh√¥ng, B·ªè qua</button>
        </div>
    </div>
</div>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color:var(--primary); margin-top:0">CH·∫§M C√îNG UTC</h2>
        <div class="login-tabs">
            <div class="login-tab active" onclick="switchLoginTab('emp')">Nh√¢n Vi√™n</div>
            <div class="login-tab" onclick="switchLoginTab('admin')">Qu·∫£n Tr·ªã</div>
        </div>

        <div id="login-form-emp" class="login-form active">
            <input type="number" id="login-emp-id" placeholder="Nh·∫≠p ID V√¢n Tay c·ªßa b·∫°n...">
            <button class="btn-primary" onclick="loginAsEmployee()">Xem L·ªãch S·ª≠</button>
        </div>

        <div id="login-form-admin" class="login-form">
            <input type="text" id="login-admin-user" placeholder="T√™n ƒëƒÉng nh·∫≠p (UTC)">
            <input type="password" id="login-admin-pass" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-primary" onclick="loginAsAdmin()">ƒêƒÉng Nh·∫≠p Admin</button>
        </div>
        <div id="login-error" style="color:var(--danger); display:none; margin-top:10px; font-size:0.9em"></div>
    </div>
</div>

<div id="main-app" class="app-container">
    
    <div class="header-bar">
        <div>
            <h3 style="margin:0; font-size: 1.2em" id="welcome-msg">Xin ch√†o</h3>
            <span id="role-badge" style="background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:4px; font-size:0.8em">User</span>
        </div>
        <button class="logout-btn" onclick="logout()">ƒêƒÉng Xu·∫•t ‚ûî</button>
    </div>

    <div id="view-employee" class="view-section">
        <div class="card">
            <h4>üìÖ L·ªãch S·ª≠ Ch·∫•m C√¥ng C√° Nh√¢n</h4>
            <table>
                <thead><tr><th>Th·ªùi Gian</th><th>ID</th><th>Tr·∫°ng Th√°i</th></tr></thead>
                <tbody id="emp-history-body"><tr><td colspan="3">ƒêang t·∫£i...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="view-admin" class="view-section">
        <div class="admin-nav">
            <div class="nav-item active" onclick="switchAdminTab('live', this)">üìä Gi√°m S√°t</div>
            <div class="nav-item" onclick="switchAdminTab('report', this)">üí∞ T√≠nh L∆∞∆°ng</div>
            <div class="nav-item" onclick="switchAdminTab('manage', this)">üë• Nh√¢n S·ª±</div>
        </div>

        <div id="adm-tab-live" class="view-section active">
            <div class="card">
                <h4>üî¥ Ho·∫°t ƒê·ªông Th·ªùi Gian Th·ª±c</h4>
                <table>
                    <thead><tr><th width="30%">Th·ªùi Gian</th><th width="10%">ID</th><th>H·ªç T√™n</th></tr></thead>
                    <tbody id="adm-live-body"></tbody>
                </table>
            </div>
        </div>

        <div id="adm-tab-report" class="view-section">
            <div class="card">
                <h4>B·ªô L·ªçc & T√≠nh To√°n</h4>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <div style="flex:1"><label><b>Th√°ng:</b></label><input type="month" id="filter-month"></div>
                    <div style="flex:1"><label><b>L∆∞∆°ng/Ng√†y:</b></label><input type="number" id="salary-input" value="500000"></div>
                </div>
                <div class="btn-group">
                    <button class="btn-primary" onclick="calcSalary()">üîç T√≠nh L∆∞∆°ng</button>
                    <button class="btn-success" onclick="exportExcel()">üì• Xu·∫•t Excel</button>
                </div>
            </div>
            <div class="card">
                <h4>K·∫øt Qu·∫£</h4>
                <table id="salary-table">
                    <thead><tr><th>ID</th><th>H·ªç T√™n</th><th>C√¥ng</th><th>Th·ª±c Lƒ©nh</th></tr></thead>
                    <tbody id="salary-body"><tr><td colspan="4" style="text-align:center">Vui l√≤ng ch·ªçn th√°ng v√† b·∫•m T√≠nh L∆∞∆°ng</td></tr></tbody>
                </table>
                <h3 style="text-align:right; margin-top:20px; color:var(--success)">T·ªïng Chi: <span id="total-payout">0 ƒë</span></h3>
            </div>
        </div>

        <div id="adm-tab-manage" class="view-section">
            <div style="display:flex; gap:20px;">
                <div class="card" style="flex:1; height:fit-content">
                    <h4>üìù Th√¥ng Tin Nh√¢n Vi√™n</h4>
                    <label>ID V√¢n Tay:</label>
                    <input type="number" id="inp-id" placeholder="Nh·∫≠p ID (V√≠ d·ª•: 1)">
                    <label>H·ªç v√† T√™n:</label>
                    <input type="text" id="inp-name" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n">
                    
                    <button class="btn-primary" onclick="saveUser()">üíæ L∆∞u Th√¥ng Tin</button>
                    <button class="btn-danger" id="btn-delete" style="display:none; margin-top:10px" onclick="deleteUser()">üóëÔ∏è X√≥a Nh√¢n Vi√™n N√†y</button>
                </div>

                <div class="card" style="flex:2;">
                    <h4>Danh S√°ch Hi·ªán C√≥</h4>
                    <div style="max-height:400px; overflow-y:auto">
                        <table id="user-list-table">
                            <thead><tr><th>ID</th><th>T√™n Nh√¢n Vi√™n</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // === C·∫§U H√åNH FIREBASE ===
    const firebaseConfig = {
        apiKey: "API_KEY_CUA_BAN", 
        authDomain: "quanlychamcong-9dacd.firebaseapp.com",
        databaseURL: "https://quanlychamcong-9dacd-default-rtdb.firebaseio.com",
        projectId: "quanlychamcong-9dacd",
        storageBucket: "quanlychamcong-9dacd.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === BI·∫æN TO√ÄN C·ª§C ===
    let usersCache = {};
    let reportData = [];
    let newIDDetected = null; // L∆∞u ID m·ªõi t·∫°m th·ªùi

    // ================= 1. X·ª¨ L√ù S·ª∞ KI·ªÜN ID M·ªöI (QUAN TR·ªåNG) =================
    db.ref('new_enroll').on('value', snap => {
        const val = snap.val();
        if (val) {
            // C√≥ ID m·ªõi -> Hi·ªán Popup
            newIDDetected = val;
            document.getElementById('modal-id-display').innerText = val;
            document.getElementById('new-id-modal').style.display = 'flex';
        } else {
            document.getElementById('new-id-modal').style.display = 'none';
        }
    });

    function acceptNewID() {
        // 1. T·∫Øt popup
        document.getElementById('new-id-modal').style.display = 'none';
        
        // 2. Chuy·ªÉn ngay sang tab Qu·∫£n L√Ω Nh√¢n S·ª± (N·∫øu ƒëang l√† Admin)
        if(document.getElementById('view-admin').style.display !== 'none') { // Ch·ªâ chuy·ªÉn n·∫øu ƒëang login admin
            // K√≠ch ho·∫°t tab Manage
            const manageTabBtn = document.querySelectorAll('.nav-item')[2];
            switchAdminTab('manage', manageTabBtn);
            
            // 3. ƒêi·ªÅn s·∫µn th√¥ng tin
            document.getElementById('inp-id').value = newIDDetected;
            document.getElementById('inp-name').value = ""; // Reset t√™n ƒë·ªÉ nh·∫≠p m·ªõi
            document.getElementById('inp-name').focus();
        }
        
        // 4. X√≥a t√≠n hi·ªáu new_enroll tr√™n Firebase ƒë·ªÉ kh√¥ng hi·ªán l·∫°i
        db.ref('new_enroll').remove();
    }

    function closeNewIDModal() {
        // Ch·ªâ t·∫Øt popup v√† x√≥a tr√™n database
        db.ref('new_enroll').remove();
        document.getElementById('new-id-modal').style.display = 'none';
    }

    // ================= 2. LOGIC ƒêƒÇNG NH·∫¨P =================
    function switchLoginTab(type) {
        document.querySelectorAll('.login-tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.login-form').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`login-form-${type}`).classList.add('active');
        document.getElementById('login-error').style.display = 'none';
    }

    function loginAsAdmin() {
        const u = document.getElementById('login-admin-user').value;
        const p = document.getElementById('login-admin-pass').value;
        if (u === "UTC" && p === "admin") {
            setupApp('Qu·∫£n Tr·ªã Vi√™n', 'Admin', 'view-admin');
            loadAdminData();
        } else {
            showError("Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!");
        }
    }

    function loginAsEmployee() {
        const id = document.getElementById('login-emp-id').value;
        if (!id) return showError("Vui l√≤ng nh·∫≠p ID!");
        db.ref('users/' + id).once('value', snap => {
            const name = snap.val() || "Nh√¢n vi√™n " + id;
            setupApp(name, 'Nh√¢n Vi√™n', 'view-employee');
            loadEmployeeData(id);
        });
    }

    function setupApp(name, role, viewId) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-app').classList.add('active');
        document.getElementById('welcome-msg').innerText = "Xin ch√†o, " + name;
        document.getElementById('role-badge').innerText = role;
        
        // ·∫®n t·∫•t c·∫£ view con
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        // Hi·ªán view ch√≠nh (Admin ho·∫∑c Employee)
        document.getElementById(viewId).style.display = 'block';

        // N·∫øu l√† admin, m·∫∑c ƒë·ªãnh active tab ƒë·∫ßu ti√™n
        if(role === 'Admin') {
             document.getElementById('adm-tab-live').style.display = 'block';
        }
    }

    function showError(msg) {
        const el = document.getElementById('login-error');
        el.innerText = msg;
        el.style.display = 'block';
    }
    function logout() { location.reload(); }

    // ================= 3. LOGIC ADMIN =================
    
    // Chuy·ªÉn Tab Admin
    function switchAdminTab(tabName, btnElement) {
        // ·∫®n t·∫•t c·∫£ tab n·ªôi dung
        document.getElementById('adm-tab-live').style.display = 'none';
        document.getElementById('adm-tab-report').style.display = 'none';
        document.getElementById('adm-tab-manage').style.display = 'none';
        
        // B·ªè active class ·ªü menu
        if(btnElement) {
             document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
             btnElement.classList.add('active');
        } else {
            // Tr∆∞·ªùng h·ª£p g·ªçi t·ª´ code (kh√¥ng click)
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            // Gi·∫£ ƒë·ªãnh th·ª© t·ª±: Live(0), Report(1), Manage(2)
            if(tabName === 'manage') document.querySelectorAll('.nav-item')[2].classList.add('active');
        }

        // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
        document.getElementById('adm-tab-' + tabName).style.display = 'block';
    }

    // T·∫£i d·ªØ li·ªáu Admin
    function loadAdminData() {
        // Cache users
        db.ref('users').on('value', snap => {
            usersCache = snap.val() || {};
            renderUserList();
        });

        // Live Monitor
        db.ref('attendance').limitToLast(20).on('value', snap => {
            const tbody = document.getElementById('adm-live-body');
            tbody.innerHTML = "";
            const data = snap.val();
            if(!data) return;
            Object.values(data).reverse().forEach(log => {
                const name = usersCache[log.id] || `<span style="color:red; font-style:italic">Ch∆∞a ƒë·∫∑t t√™n</span>`;
                tbody.innerHTML += `<tr><td>${log.timestamp}</td><td><span style="background:#e0f2fe; color:#0284c7; padding:2px 6px; border-radius:4px; font-weight:bold">${log.id}</span></td><td>${name}</td></tr>`;
            });
        });
    }

    // Qu·∫£n l√Ω User
    function renderUserList() {
        const tbody = document.querySelector('#user-list-table tbody');
        tbody.innerHTML = "";
        Object.keys(usersCache).forEach(id => {
            tbody.innerHTML += `<tr onclick="editUser('${id}', '${usersCache[id]}')" style="cursor:pointer"><td><b>${id}</b></td><td>${usersCache[id]}</td></tr>`;
        });
    }

    function saveUser() {
        const id = document.getElementById('inp-id').value;
        const name = document.getElementById('inp-name').value;
        if(id && name) {
            db.ref('users/' + id).set(name);
            alert("ƒê√£ l∆∞u th√¥ng tin nh√¢n vi√™n!");
            resetForm();
        } else {
            alert("Vui l√≤ng nh·∫≠p ƒë·ªß ID v√† T√™n");
        }
    }
    
    function deleteUser() {
        const id = document.getElementById('inp-id').value;
        if(confirm("Ch·∫Øc ch·∫Øn x√≥a nh√¢n vi√™n n√†y?")) {
            db.ref('users/' + id).remove();
            resetForm();
        }
    }

    function editUser(id, name) {
        document.getElementById('inp-id').value = id;
        document.getElementById('inp-name').value = name;
        document.getElementById('btn-delete').style.display = 'inline-block';
    }

    function resetForm() {
        document.getElementById('inp-id').value = "";
        document.getElementById('inp-name').value = "";
        document.getElementById('btn-delete').style.display = 'none';
    }

    // T√≠nh L∆∞∆°ng (Gi·ªØ nguy√™n logic c≈©)
    async function calcSalary() {
        const month = document.getElementById('filter-month').value;
        const salary = document.getElementById('salary-input').value;
        if(!month) return alert("Vui l√≤ng ch·ªçn th√°ng!");

        const tbody = document.getElementById('salary-body');
        tbody.innerHTML = "<tr><td colspan='4'>ƒêang t√≠nh to√°n...</td></tr>";

        const snap = await db.ref('attendance').once('value');
        const data = snap.val();
        let stats = {};
        const [y, m] = month.split('-');
        
        if(data) {
            Object.values(data).forEach(log => {
                try {
                    // X·ª≠ l√Ω ng√†y th√°ng format DD/MM/YYYY
                    let dStr = log.timestamp.split(' ')[0];
                    let [dd, mm, yy] = dStr.split('/');
                    if(yy == y && mm == m) {
                        if(!stats[log.id]) stats[log.id] = new Set();
                        stats[log.id].add(dd);
                    }
                } catch(e){}
            });
        }

        tbody.innerHTML = "";
        reportData = [];
        let total = 0;
        Object.keys(stats).forEach(id => {
            const days = stats[id].size;
            const money = days * salary;
            const name = usersCache[id] || "Unknown";
            total += money;
            reportData.push({ID: id, Name: name, Days: days, Salary: money});
            tbody.innerHTML += `<tr><td>${id}</td><td>${name}</td><td style="font-weight:bold">${days}</td><td style="color:var(--success); font-weight:bold">${money.toLocaleString()} ƒë</td></tr>`;
        });
        document.getElementById('total-payout').innerText = total.toLocaleString() + " ƒë";
        if(reportData.length == 0) tbody.innerHTML = "<tr><td colspan='4'>Kh√¥ng c√≥ d·ªØ li·ªáu th√°ng n√†y</td></tr>";
    }

    function exportExcel() {
        if(reportData.length == 0) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!");
        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Luong");
        XLSX.writeFile(wb, "BangLuong.xlsx");
    }

    // ================= 4. LOGIC NH√ÇN VI√äN =================
    function loadEmployeeData(myId) {
        const tbody = document.getElementById('emp-history-body');
        db.ref('attendance').limitToLast(50).on('value', snap => {
            tbody.innerHTML = "";
            const data = snap.val();
            if(!data) return;
            Object.values(data).reverse().forEach(log => {
                if(log.id == myId) {
                    tbody.innerHTML += `<tr><td>${log.timestamp}</td><td><b>${log.id}</b></td><td style="color:var(--success)">‚úî Th√†nh c√¥ng</td></tr>`;
                }
            });
        });
    }

    // Set th√°ng m·∫∑c ƒë·ªãnh
    const d = new Date();
    document.getElementById('filter-month').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

</script>
</body>
</html>
