<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ch·∫•m C√¥ng UTC</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        
        /* LOGIN SCREEN STYLES */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 10px; width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
        }
        .login-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .login-tab { flex: 1; padding: 10px; cursor: pointer; color: #777; font-weight: bold; }
        .login-tab.active { color: #1a73e8; border-bottom: 3px solid #1a73e8; }
        .login-form { display: none; }
        .login-form.active { display: block; }
        
        /* MAIN DASHBOARD STYLES */
        .app-container { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .app-container.active { display: block; }

        /* Header Bar */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .logout-btn { background: #ea4335; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Common Elements */
        input, button, select { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        button { cursor: pointer; font-weight: bold; color: white; border: none; }
        .btn-blue { background: #1a73e8; } .btn-green { background: #34a853; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #1a73e8; color: white; }
        tr:hover { background-color: #f8f9fa; }

        /* Specific for Admin/User Views */
        .admin-view, .emp-view { display: none; }
        .admin-view.show, .emp-view.show { display: block; }
        
        /* Layout columns */
        .row { display: flex; gap: 20px; }
        .col-2 { flex: 2; } .col-1 { flex: 1; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }

        /* Tabs inside Admin */
        .sub-tabs { margin-bottom: 15px; }
        .sub-tab-btn { padding: 8px 15px; border: none; background: #eee; cursor: pointer; margin-right: 5px; border-radius: 5px; }
        .sub-tab-btn.active { background: #1a73e8; color: white; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color:#1a73e8; margin-top:0">H·ªÜ TH·ªêNG CH·∫§M C√îNG</h2>
        <div class="login-tabs">
            <div class="login-tab active" onclick="switchLoginTab('emp')">Nh√¢n Vi√™n</div>
            <div class="login-tab" onclick="switchLoginTab('admin')">Qu·∫£n Tr·ªã Vi√™n</div>
        </div>

        <div id="login-form-emp" class="login-form active">
            <p>Nh·∫≠p ID V√¢n Tay c·ªßa b·∫°n ƒë·ªÉ xem c√¥ng</p>
            <input type="number" id="login-emp-id" placeholder="V√≠ d·ª•: 1">
            <button class="btn-blue" onclick="loginAsEmployee()">Xem Ch·∫•m C√¥ng</button>
        </div>

        <div id="login-form-admin" class="login-form">
            <input type="text" id="login-admin-user" placeholder="T√™n ƒëƒÉng nh·∫≠p (UTC)">
            <input type="password" id="login-admin-pass" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-blue" onclick="loginAsAdmin()">ƒêƒÉng Nh·∫≠p Admin</button>
        </div>
        <p id="login-error" style="color:red; display:none; font-size: 0.9em; margin-top:5px"></p>
    </div>
</div>

<div id="main-app" class="app-container">
    
    <div class="header-bar">
        <div>
            <h3 style="margin:0" id="welcome-msg">Xin ch√†o</h3>
            <small id="role-badge" style="background:#eee; padding:2px 6px; border-radius:4px">Role</small>
        </div>
        <button class="logout-btn" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
    </div>

    <div id="view-employee" class="emp-view">
        <div class="card">
            <h4>üìÖ L·ªãch S·ª≠ Ch·∫•m C√¥ng C·ªßa B·∫°n</h4>
            <table>
                <thead><tr><th>Th·ªùi Gian</th><th>ID</th><th>Tr·∫°ng Th√°i</th></tr></thead>
                <tbody id="emp-history-body">
                    <tr><td colspan="3">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="view-admin" class="admin-view">
        <div class="sub-tabs">
            <button class="sub-tab-btn active" onclick="switchAdminTab('live')">üî¥ Gi√°m S√°t</button>
            <button class="sub-tab-btn" onclick="switchAdminTab('report')">üìä B√°o C√°o & L∆∞∆°ng</button>
            <button class="sub-tab-btn" onclick="switchAdminTab('manage')">üë• Nh√¢n S·ª±</button>
        </div>

        <div id="adm-tab-live" style="display:block">
            <div class="card">
                <h4>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y (T·∫•t c·∫£ nh√¢n vi√™n)</h4>
                <table>
                    <thead><tr><th>Th·ªùi Gian</th><th>ID</th><th>H·ªç T√™n</th></tr></thead>
                    <tbody id="adm-live-body"></tbody>
                </table>
            </div>
        </div>

        <div id="adm-tab-report" style="display:none">
            <div class="card" style="display:flex; gap:10px; align-items:flex-end">
                <div style="flex:1"><label>Ch·ªçn th√°ng:</label><input type="month" id="filter-month"></div>
                <div style="flex:1"><label>L∆∞∆°ng/Ng√†y:</label><input type="number" id="salary-input" value="500000"></div>
                <button class="btn-blue" style="width:auto; height:42px" onclick="calcSalary()">T√≠nh L∆∞∆°ng</button>
                <button class="btn-green" style="width:auto; height:42px" onclick="exportExcel()">Xu·∫•t Excel</button>
            </div>
            <div class="card">
                <table id="salary-table">
                    <thead><tr><th>ID</th><th>H·ªç T√™n</th><th>S·ªë C√¥ng</th><th>T·ªïng L∆∞∆°ng</th></tr></thead>
                    <tbody id="salary-body"><tr><td colspan="4">Ch·ªçn th√°ng ƒë·ªÉ xem</td></tr></tbody>
                </table>
                <div style="text-align:right; margin-top:10px; font-weight:bold">T·ªïng chi: <span id="total-payout" style="color:green">0 ƒë</span></div>
            </div>
        </div>

        <div id="adm-tab-manage" style="display:none">
            <div class="row">
                <div class="col-1 card">
                    <h4>Th√™m / S·ª≠a Nh√¢n Vi√™n</h4>
                    <input type="number" id="inp-id" placeholder="ID V√¢n Tay">
                    <input type="text" id="inp-name" placeholder="H·ªç T√™n">
                    <button class="btn-green" onclick="saveUser()">L∆∞u</button>
                </div>
                <div class="col-2 card">
                    <h4>Danh S√°ch</h4>
                    <table id="user-list-table">
                        <thead><tr><th>ID</th><th>T√™n</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // === C·∫§U H√åNH FIREBASE ===
    const firebaseConfig = {
        apiKey: "API_KEY_CUA_BAN", 
        authDomain: "quanlychamcong-9dacd.firebaseapp.com",
        databaseURL: "https://quanlychamcong-9dacd-default-rtdb.firebaseio.com",
        projectId: "quanlychamcong-9dacd",
        storageBucket: "quanlychamcong-9dacd.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === BI·∫æN TO√ÄN C·ª§C ===
    let usersCache = {};
    let currentUser = null; // L∆∞u ID nh√¢n vi√™n ho·∫∑c 'admin'
    let reportData = []; // D·ªØ li·ªáu excel

    // === 1. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P ===
    function switchLoginTab(type) {
        document.querySelectorAll('.login-tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.login-form').forEach(el => el.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(`login-form-${type}`).classList.add('active');
        document.getElementById('login-error').style.display = 'none';
    }

    // ƒêƒÉng nh·∫≠p Admin
    function loginAsAdmin() {
        const u = document.getElementById('login-admin-user').value;
        const p = document.getElementById('login-admin-pass').value;

        if (u === "UTC" && p === "admin") {
            currentUser = 'admin';
            enterApp('Qu·∫£n Tr·ªã Vi√™n', 'Admin', 'view-admin');
            loadAdminData();
        } else {
            showError("Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!");
        }
    }

    // ƒêƒÉng nh·∫≠p Nh√¢n vi√™n
    function loginAsEmployee() {
        const id = document.getElementById('login-emp-id').value;
        if (!id) return showError("Vui l√≤ng nh·∫≠p ID!");

        // Ki·ªÉm tra xem ID c√≥ t·ªìn t·∫°i trong h·ªá th·ªëng kh√¥ng (Optional)
        db.ref('users/' + id).once('value', snap => {
            const name = snap.val() || "Nh√¢n vi√™n " + id;
            currentUser = id;
            enterApp(name, 'Nh√¢n Vi√™n', 'view-employee');
            loadEmployeeData(id);
        });
    }

    function enterApp(name, role, viewId) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-app').classList.add('active');
        document.getElementById('welcome-msg').innerText = "Xin ch√†o, " + name;
        document.getElementById('role-badge').innerText = role;
        
        // ·∫®n t·∫•t c·∫£ view, hi·ªán view ph√π h·ª£p
        document.querySelectorAll('.admin-view, .emp-view').forEach(el => el.classList.remove('show'));
        document.getElementById(viewId).classList.add('show');
    }

    function logout() {
        location.reload(); // C√°ch ƒë∆°n gi·∫£n nh·∫•t ƒë·ªÉ reset
    }

    function showError(msg) {
        const err = document.getElementById('login-error');
        err.innerText = msg;
        err.style.display = 'block';
    }

    // === 2. LOGIC CHO NH√ÇN VI√äN ===
    function loadEmployeeData(myId) {
        const tbody = document.getElementById('emp-history-body');
        // L·∫•y 100 b·∫£n ghi m·ªõi nh·∫•t ƒë·ªÉ l·ªçc
        db.ref('attendance').limitToLast(100).on('value', snap => {
            tbody.innerHTML = "";
            const data = snap.val();
            if(!data) { tbody.innerHTML = "<tr><td colspan='3'>Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>"; return; }

            const logs = Object.values(data).reverse();
            let count = 0;
            logs.forEach(log => {
                // Ch·ªâ hi·ªán log c√≥ ID tr√πng v·ªõi ID ƒëƒÉng nh·∫≠p
                if (log.id == myId) {
                    tbody.innerHTML += `
                        <tr>
                            <td>${log.timestamp}</td>
                            <td><span style="background:#e8f0fe; padding:2px 5px; border-radius:3px">${log.id}</span></td>
                            <td style="color:green">‚úî ƒê√£ ch·∫•m c√¥ng</td>
                        </tr>
                    `;
                    count++;
                }
            });
            if(count === 0) tbody.innerHTML = "<tr><td colspan='3'>B·∫°n ch∆∞a ch·∫•m c√¥ng l·∫ßn n√†o.</td></tr>";
        });
    }

    // === 3. LOGIC CHO ADMIN ===
    
    // T·∫£i danh s√°ch User (cache)
    db.ref('users').on('value', snap => {
        usersCache = snap.val() || {};
        renderUserList();
    });

    function loadAdminData() {
        // Tab Live Monitor
        db.ref('attendance').limitToLast(20).on('value', snap => {
            const tbody = document.getElementById('adm-live-body');
            tbody.innerHTML = "";
            const data = snap.val();
            if(!data) return;

            Object.values(data).reverse().forEach(log => {
                const name = usersCache[log.id] || "Ch∆∞a ƒë·∫∑t t√™n";
                tbody.innerHTML += `<tr><td>${log.timestamp}</td><td>${log.id}</td><td><b>${name}</b></td></tr>`;
            });
        });
    }

    function switchAdminTab(tab) {
        // ·∫®n h·∫øt c√°c div con c·ªßa admin
        document.getElementById('adm-tab-live').style.display = 'none';
        document.getElementById('adm-tab-report').style.display = 'none';
        document.getElementById('adm-tab-manage').style.display = 'none';
        
        // Reset active button
        document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        // Hi·ªán div ƒë∆∞·ª£c ch·ªçn
        document.getElementById('adm-tab-' + tab).style.display = 'block';
    }

    // --- T√≠nh nƒÉng qu·∫£n l√Ω user ---
    function renderUserList() {
        const tbody = document.querySelector('#user-list-table tbody');
        tbody.innerHTML = "";
        Object.keys(usersCache).forEach(id => {
            tbody.innerHTML += `<tr onclick="fillForm('${id}', '${usersCache[id]}')" style="cursor:pointer"><td>${id}</td><td>${usersCache[id]}</td></tr>`;
        });
    }

    function saveUser() {
        const id = document.getElementById('inp-id').value;
        const name = document.getElementById('inp-name').value;
        if(id && name) {
            db.ref('users/' + id).set(name);
            alert("ƒê√£ l∆∞u!");
            document.getElementById('inp-id').value = "";
            document.getElementById('inp-name').value = "";
        }
    }
    
    function fillForm(id, name) {
        document.getElementById('inp-id').value = id;
        document.getElementById('inp-name').value = name;
    }

    // --- T√≠nh nƒÉng L∆∞∆°ng (Gi·ªëng code c≈© nh∆∞ng t√≠ch h·ª£p) ---
    async function calcSalary() {
        const month = document.getElementById('filter-month').value;
        const salary = document.getElementById('salary-input').value;
        if(!month) return alert("Ch·ªçn th√°ng!");

        const tbody = document.getElementById('salary-body');
        tbody.innerHTML = "<tr><td colspan='4'>ƒêang t√≠nh to√°n...</td></tr>";

        const snap = await db.ref('attendance').once('value');
        const data = snap.val();
        
        // Logic t√≠nh to√°n
        let stats = {};
        const [y, m] = month.split('-');
        
        if(data) {
            Object.values(data).forEach(log => {
                // Parse date format: DD/MM/YYYY HH:mm:ss
                try {
                    let parts = log.timestamp.split(' ')[0].split('/'); // [DD, MM, YYYY]
                    if(parts[2] == y && parts[1] == m) {
                        if(!stats[log.id]) stats[log.id] = new Set();
                        stats[log.id].add(parts[0]); // Th√™m ng√†y v√†o Set
                    }
                } catch(e){}
            });
        }

        tbody.innerHTML = "";
        reportData = [];
        let total = 0;

        Object.keys(stats).forEach(id => {
            const days = stats[id].size;
            const money = days * salary;
            const name = usersCache[id] || "Unknown";
            total += money;

            reportData.push({ID: id, Name: name, Days: days, Salary: money});

            tbody.innerHTML += `<tr><td>${id}</td><td>${name}</td><td>${days}</td><td>${money.toLocaleString()} ƒë</td></tr>`;
        });
        
        document.getElementById('total-payout').innerText = total.toLocaleString() + " ƒë";
        if(reportData.length == 0) tbody.innerHTML = "<tr><td colspan='4'>Kh√¥ng c√≥ d·ªØ li·ªáu th√°ng n√†y</td></tr>";
    }

    function exportExcel() {
        if(reportData.length == 0) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!");
        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Luong");
        XLSX.writeFile(wb, "BangLuong.xlsx");
    }

    // M·∫∑c ƒë·ªãnh th√°ng hi·ªán t·∫°i
    const d = new Date();
    document.getElementById('filter-month').value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

</script>

</body>
</html>
